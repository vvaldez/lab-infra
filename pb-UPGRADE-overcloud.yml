---
- hosts: localhost
  connection: local
  gather_facts: no
  vars:
    vars_prompt_message: Confirm the environment to target
    vars_prompt_expected: "{{ datacenter }}-{{ named_env }}"
    vars_prompt_disable: "{{ disable_prompt | default('no') }}"
  roles:
    - vars-prompt
  tags:
    - always


# https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/13/html-single/keeping_red_hat_openstack_platform_updated/index
- name: 3.1. Performing a minor update of an undercloud
  hosts: director
  become: yes
  become_user: stack
  gather_facts: no
  tasks:
    - yum:
        name: python-tripleoclient
        state: latest

    #######
    #######
    # This command kills networking immediately.....
    #######
    #######
    - block:
        - name: openstack undercloud upgrade
          shell: |
            cd ~ &&
            source ~/stackrc && \
            openstack undercloud upgrade
          async: 1800
          poll: 30

      rescue:
        - debug:
            msg: rescue

      always:
        - debug:
            msg: always

    - name: Reboot
      reboot:



- name: 3.2. Updating the overcloud images
  hosts: director
  become: yes
  become_user: stack
  gather_facts: no
  tasks:
    - shell: rm -rf ~/images/*

    - shell: |
        cd ~/images
        for i in /usr/share/rhosp-director-images/overcloud-full-latest-13.0.tar /usr/share/rhosp-director-images/ironic-python-agent-latest-13.0.tar; do tar -xvf $i; done
        cd ~

    - shell: |
        cd ~/images &&
        source ~/stackrc && \
        openstack overcloud image upload --update-existing --image-path /home/stack/images/

    - shell: openstack overcloud node configure $(openstack baremetal node list -c UUID -f value)

    - shell: |
        cd ~ &&
        source ~/stackrc && \
        openstack image list
      register: openstack_image_list

    - debug:
        var: openstack_image_list.stdout



- name: 4.2. Running the overcloud update preparation
  hosts: director
  become: yes
  become_user: stack
  gather_facts: no
  tasks:
    - block:
        - name: openstack overcloud update prepare
          shell: |
            cd ~ &&
            source ~/stackrc && \
            ~/ansible-generated/scripts/overcloud-update-prepare.sh
          async: 3600
          poll: 30

      rescue:
        - debug:
            msg: rescue

      always:
        - debug:
            msg: always



- name: 4.3. Updating all Controller nodes
  hosts: director
  become: yes
  become_user: stack
  gather_facts: no
  tasks:
    - block:
        - name: openstack overcloud update run --nodes Controller
          shell: |
            cd ~ &&
            source ~/stackrc && \
            openstack overcloud update run --nodes Controller
          async: 3600
          poll: 30

      rescue:
        - debug:
            msg: rescue

      always:
        - debug:
            msg: always



- name: 4.4. Updating all ComputeDVR nodes
  hosts: director
  become: yes
  become_user: stack
  gather_facts: no
  tasks:
    - block:
        - name: v
          shell: |
            cd ~ &&
            source ~/stackrc && \
            openstack overcloud update run --nodes ComputeDVR
          async: 3600
          poll: 30

      rescue:
        - debug:
            msg: rescue

      always:
        - debug:
            msg: always



- name: 4.7. Finalizing the update
  hosts: director
  become: yes
  become_user: stack
  gather_facts: no
  tasks:
    - block:
        - name: openstack overcloud update converge
          shell: |
            cd ~ &&
            source ~/stackrc && \
            ~/ansible-generated/scripts/overcloud-update-converge.sh
          async: 3600
          poll: 30

      rescue:
        - debug:
            msg: rescue

      always:
        - debug:
            msg: always

---
- hosts: localhost
  connection: local
  gather_facts: no
  vars:
    vars_prompt_message: Confirm the environment to target
    vars_prompt_expected: "{{ datacenter }}-{{ named_env }}"
    vars_prompt_disable: "{{ disable_prompt | default('no') }}"
  roles:
    - vars-prompt
  tags:
    - always



- name: Fetch overcloudrc and SSH keys locally
  hosts: director
  become: yes
  become_user: stack
  gather_facts: no
  tasks:
    - block:
        - name: Fetch overcloudrc to ./files/ locally
          fetch:
            src: "/home/stack/overcloud-{{ named_env }}rc"
            dest: "{{ lookup('env', 'PWD') }}/files/"
            flat: yes

        - name: Fetch heat-admin private key locally
          fetch:
            src: "/home/stack/.ssh/id_rsa"
            dest: "~/.ssh/{{ named_env }}_rsa"
            flat: yes

        - name: Ensure 0600 on the local private key file
          file:
            path: "~/.ssh/{{ named_env }}_rsa"
            state: file
            mode: 0600
          become: no
          connection: local
          delegate_to: localhost

        - name: Fetch the heat-admin public key locally
          fetch:
            src: "/home/stack/.ssh/id_rsa.pub"
            dest: "~/.ssh/{{ named_env }}_rsa.pub"
            flat: yes

      tags:
        - fetch

    - block:
        - name: Grab the list of existing HEAT stacks on the overcloud
          shell: ". ~/overcloud-{{ named_env }}rc && openstack stack list  -c 'Stack Name' -f value"
          register: stack_output
          changed_when: false

        - name: Create the base-flavors stack if it doesn't exist
          shell: ". ~/overcloud-{{ named_env }}rc && openstack stack create -t ~/ansible-generated/heat/flavors.yaml ansible-generated-base-flavors --wait"
          register: shell_output
          when: "'ansible-generated-base-flavors' not in stack_output.stdout_lines"

        - name: Show output
          debug:
            var: shell_output.stdout
          when: shell_output.stdout is defined

        - name: Create the ansible-generated-base-networks stack if it doesn't exist
          shell: ". ~/overcloud-{{ named_env }}rc && openstack stack create -t ~/ansible-generated/heat/external_network.yaml ansible-generated-base-networks --wait"
          register: shell_output
          when: "'ansible-generated-base-networks' not in stack_output.stdout_lines"

        - name: Show output
          debug:
            var: shell_output.stdout
          when: shell_output.stdout is defined

        - name: Create the ansible-generated-tempest-networks stack if it doesn't exist
          shell: ". ~/overcloud-{{ named_env }}rc && openstack stack create -t ~/ansible-generated/heat/external_tempest.yaml ansible-generated-tempest-networks --wait"
          register: shell_output
          when: "'ansible-generated-tempest-networks' not in stack_output.stdout_lines"

        - name: Show output
          debug:
            var: shell_output.stdout
          when: shell_output.stdout is defined

      tags:
        - stacks
